## Video Encoder Microservice

### Setting up the environment

To run in development mode, follow these steps:

1. Duplicate the `.env.example` file and rename it to `.env`.
2. Run the command `docker-compose up -d`.
3. Access the RabbitMQ administration and create a fanout exchange. This exchange will serve as a Dead Letter Exchange to receive messages that are not processed.
4. Create a Dead Letter Queue and bind it to the newly created Dead Letter Exchange. There is no need for a `routing_key`.
5. In the `.env` file, provide the name of the Dead Letter Exchange in the parameter: `RABBITMQ_DLX`.
6. Create a service account in GCP with write permissions to Google Cloud Storage. Download the JSON credentials file and save it in the project's root directory with the name: `bucket-credential.json`.

### Running the Encoder

To run the encoder, execute the command `make server` directly in the container. Example:

```
docker exec encoder-new2_app_1 make server
```

Here, `microsservico-enconder_app_1` is the name of the container generated by docker-compose.

### Message Format for Encoder

To parse a message in the encoder system, it should arrive in the following JSON format:

```json
{
  "resource_id": "my-resource-id-can-be-a-uuid-type",
  "file_path": "convite.mp4"
}
```

- `resource_id`: Represents the ID of the video you want to convert. It is of string type.
- `file_path`: The full path of the MP4 video within the bucket.

### Message Format for Encoder Response

#### Successful Processing

For each processed video, the encoder will send the processing result to an exchange (to be configured in `.env`). If the processing was completed successfully, the JSON response format will be:

```json
{
    "id": "bbbdd123-ad05-4dc8-a74c-d63a0a2423d5",
    "output_bucket_path": "codeeducationtest",
    "status": "COMPLETED",
    "video": {
        "encoded_video_folder": "b3f2d41e-2c0a-4830-bd65-68227e97764f",
        "resource_id": "aadc5ff9-0b0d-13ab-4a40-a11b2eaa148c",
        "file_path": "convite.mp4"
    },
    "Error": "",
    "created_at": "2020-05-27T19:43:34.850479-04:00",
    "updated_at": "2020-05-27T19:43:38.081754-04:00"
}
```

Here, `encoded_video_folder` is the folder that contains the converted video.

#### Processing Error

If an error occurs during the processing, the JSON response format will be:

```json
{
    "message": {
        "resource_id": "aadc5ff9-010d-a3ab-4a40-a11b2eaa148c",
        "file_path": "convite.mp4"
    },
    "error": "Error reason"
}
```

Additionally, the encoder will send the original message that encountered an error during processing to a dead letter exchange. Simply configure the desired DLX in the `.env` file using the parameter `RABBITMQ_DLX`.
